const express = require("express");
const ppeController = require("../controllers/ppeController");
const router = express.Router();

// âœ… Temel monitoring route'larÄ±
router.post("/start-monitoring", ppeController.startMonitoring);
router.post("/stop-monitoring", ppeController.stopMonitoring);
router.get("/detections", ppeController.getDetections);
router.get("/stats", ppeController.getStats);
router.get("/camera/stream", ppeController.getCameraStream);
router.get("/camera/status", ppeController.getCameraStatus);

// âœ… Geriye uyumluluk
router.post("/start", ppeController.startMonitoring);
router.post("/stop", ppeController.stopMonitoring);

// âœ… Mock data route'larÄ± (controller yerine direkt tanÄ±mla)
router.get("/statistics", async (req, res) => {
  try {
    const stats = {
      totalDetections: 156,
      safeDetections: 142,
      violations: 14,
      complianceRate: 91,
      dailyStats: [
        { date: "2025-06-13", detections: 45, violations: 3 },
        { date: "2025-06-12", detections: 52, violations: 2 },
        { date: "2025-06-11", detections: 38, violations: 5 },
      ],
    };
    res.json(stats);
  } catch (error) {
    res.status(500).json({ error: "Ä°statistik verisi alÄ±namadÄ±" });
  }
});

router.get("/workers", async (req, res) => {
  try {
    const workers = [
      {
        id: 1,
        name: "Ahmet YÄ±lmaz",
        department: "Ãœretim",
        status: "active",
        lastSeen: new Date().toISOString(),
        complianceRate: 95,
      },
      {
        id: 2,
        name: "Mehmet Kaya",
        department: "Montaj",
        status: "active",
        lastSeen: new Date().toISOString(),
        complianceRate: 88,
      },
    ];
    res.json(workers);
  } catch (error) {
    res.status(500).json({ error: "Ã‡alÄ±ÅŸan verisi alÄ±namadÄ±" });
  }
});
router.get("/departments", (req, res) => {
  console.log("ðŸ¢ Departments istendi");

  const mockDepartments = [
    { id: 1, name: "Ãœretim", code: "PROD" },
    { id: 2, name: "Kalite Kontrol", code: "QC" },
    { id: 3, name: "BakÄ±m-OnarÄ±m", code: "MAINT" },
    { id: 4, name: "Depo", code: "WAREHOUSE" },
    { id: 5, name: "Ä°nsan KaynaklarÄ±", code: "HR" },
    { id: 6, name: "GÃ¼venlik", code: "SECURITY" },
  ];

  // Frontend sadece name array'i bekliyor
  const departmentNames = mockDepartments.map((dept) => dept.name);

  console.log("âœ… Departments gÃ¶nderiliyor:", departmentNames.length, "adet");
  res.json(departmentNames);
});

// 2. LokasyonlarÄ± getir
router.get("/locations", (req, res) => {
  console.log("ðŸ“ Locations istendi");

  const mockLocations = [
    { id: 1, name: "Ana Ãœretim HattÄ±", code: "MAIN_LINE" },
    { id: 2, name: "Montaj AlanÄ±", code: "ASSEMBLY" },
    { id: 3, name: "Kalite LaboratuvarÄ±", code: "QC_LAB" },
    { id: 4, name: "Hammadde Deposu", code: "RAW_STORAGE" },
    { id: 5, name: "Mamul Deposu", code: "FINISHED_STORAGE" },
    { id: 6, name: "BakÄ±m AtÃ¶lyesi", code: "MAINTENANCE_SHOP" },
    { id: 7, name: "Ofis AlanÄ±", code: "OFFICE" },
    { id: 8, name: "Yemekhane", code: "CAFETERIA" },
  ];

  // Frontend sadece name array'i bekliyor
  const locationNames = mockLocations.map((loc) => loc.name);

  console.log("âœ… Locations gÃ¶nderiliyor:", locationNames.length, "adet");
  res.json(locationNames);
});

// 3. Ã‡alÄ±ÅŸan istatistiklerini getir
router.get("/workers/statistics", (req, res) => {
  console.log("ðŸ“Š Worker statistics istendi");

  const mockStats = {
    totalWorkers: 45,
    activeWorkers: 42,
    averageCompliance: 87.5,
    totalViolations: 8,
    newWorkersThisMonth: 5,
    complianceChange: 2.3,
    violationChange: -3,
    departmentStats: [
      { department: "Ãœretim", workers: 18, compliance: 85.2 },
      { department: "Kalite Kontrol", workers: 8, compliance: 95.1 },
      { department: "BakÄ±m-OnarÄ±m", workers: 12, compliance: 82.7 },
      { department: "Depo", workers: 7, compliance: 91.4 },
    ],
    locationStats: [
      { location: "Ana Ãœretim HattÄ±", workers: 15, compliance: 83.5 },
      { location: "Montaj AlanÄ±", workers: 10, compliance: 88.9 },
      { location: "Kalite LaboratuvarÄ±", workers: 6, compliance: 96.2 },
      { location: "Depo AlanlarÄ±", workers: 14, compliance: 90.1 },
    ],
  };

  console.log("âœ… Worker statistics gÃ¶nderiliyor");
  res.json(mockStats);
});

// 4. TÃ¼m Ã§alÄ±ÅŸanlarÄ± getir
router.get("/workers", (req, res) => {
  console.log("ðŸ‘¥ Workers listesi istendi");

  const mockWorkers = [
    {
      id: 1,
      name: "Ahmet YÄ±lmaz",
      workerId: "EMP001",
      email: "ahmet.yilmaz@sirket.com",
      phone: "+90 555 123 45 67",
      department: "Ãœretim",
      location: "Ana Ãœretim HattÄ±",
      position: "Ãœretim OperatÃ¶rÃ¼",
      startDate: "2023-01-15",
      status: "active",
      managerId: 1,
      complianceRate: 92.5,
      monthlyViolations: 2,
      recentViolations: 1,
      lastSeen: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(), // 2 saat Ã¶nce
      safetyScore: 85,
      trainingStatus: "completed",
      completedTrainings: 8,
      notes: "GÃ¼venilir Ã§alÄ±ÅŸan, PPE kullanÄ±mÄ±nda dikkatli.",
      photo: null,
      assignedPPE: [
        {
          type: "Baret",
          status: "assigned",
          assignedDate: "2023-01-15",
          lastCheck: "2025-06-01",
          condition: "good",
        },
        {
          type: "GÃ¶zlÃ¼k",
          status: "assigned",
          assignedDate: "2023-01-15",
          lastCheck: "2025-06-01",
          condition: "good",
        },
        {
          type: "Eldiven",
          status: "assigned",
          assignedDate: "2023-01-15",
          lastCheck: "2025-06-01",
          condition: "fair",
        },
        {
          type: "Yelek",
          status: "assigned",
          assignedDate: "2023-01-15",
          lastCheck: "2025-06-01",
          condition: "good",
        },
      ],
      recentViolations: [
        {
          id: 1,
          type: "Eksik PPE",
          description: "GÃ¼venlik gÃ¶zlÃ¼ÄŸÃ¼ takÄ±lmamÄ±ÅŸ",
          timestamp: new Date(
            Date.now() - 3 * 24 * 60 * 60 * 1000
          ).toISOString(),
          location: "Ana Ãœretim HattÄ±",
          status: "resolved",
        },
      ],
    },
    {
      id: 2,
      name: "Fatma Demir",
      workerId: "EMP002",
      email: "fatma.demir@sirket.com",
      phone: "+90 555 234 56 78",
      department: "Kalite Kontrol",
      location: "Kalite LaboratuvarÄ±",
      position: "Kalite Kontrol UzmanÄ±",
      startDate: "2022-08-20",
      status: "active",
      managerId: 2,
      complianceRate: 98.1,
      monthlyViolations: 0,
      recentViolations: 0,
      lastSeen: new Date(Date.now() - 30 * 60 * 1000).toISOString(), // 30 dk Ã¶nce
      safetyScore: 95,
      trainingStatus: "completed",
      completedTrainings: 12,
      notes: "Ã–rnek Ã§alÄ±ÅŸan, gÃ¼venlik konularÄ±nda lider.",
      photo: null,
      assignedPPE: [
        {
          type: "Baret",
          status: "assigned",
          assignedDate: "2022-08-20",
          lastCheck: "2025-06-01",
          condition: "excellent",
        },
        {
          type: "GÃ¶zlÃ¼k",
          status: "assigned",
          assignedDate: "2022-08-20",
          lastCheck: "2025-06-01",
          condition: "good",
        },
        {
          type: "Eldiven",
          status: "assigned",
          assignedDate: "2022-08-20",
          lastCheck: "2025-06-01",
          condition: "good",
        },
        {
          type: "Maske",
          status: "assigned",
          assignedDate: "2022-08-20",
          lastCheck: "2025-06-01",
          condition: "good",
        },
      ],
      recentViolations: [],
    },
    {
      id: 3,
      name: "Mehmet Kaya",
      workerId: "EMP003",
      email: "mehmet.kaya@sirket.com",
      phone: "+90 555 345 67 89",
      department: "BakÄ±m-OnarÄ±m",
      location: "BakÄ±m AtÃ¶lyesi",
      position: "BakÄ±m Teknisyeni",
      startDate: "2023-03-10",
      status: "active",
      managerId: 3,
      complianceRate: 78.3,
      monthlyViolations: 5,
      recentViolations: 3,
      lastSeen: new Date(Date.now() - 10 * 60 * 1000).toISOString(), // 10 dk Ã¶nce
      safetyScore: 65,
      trainingStatus: "in-progress",
      completedTrainings: 4,
      notes: "GÃ¼venlik eÄŸitimi gerekiyor, PPE kullanÄ±mÄ±nda eksikler var.",
      photo: null,
      assignedPPE: [
        {
          type: "Baret",
          status: "assigned",
          assignedDate: "2023-03-10",
          lastCheck: "2025-05-15",
          condition: "fair",
        },
        {
          type: "Eldiven",
          status: "missing",
          assignedDate: "2023-03-10",
          lastCheck: "2025-05-15",
          condition: "poor",
        },
        {
          type: "AyakkabÄ±",
          status: "assigned",
          assignedDate: "2023-03-10",
          lastCheck: "2025-05-15",
          condition: "good",
        },
      ],
      recentViolations: [
        {
          id: 2,
          type: "Eksik PPE",
          description: "Ä°ÅŸ eldiveni takÄ±lmamÄ±ÅŸ",
          timestamp: new Date(
            Date.now() - 1 * 24 * 60 * 60 * 1000
          ).toISOString(),
          location: "BakÄ±m AtÃ¶lyesi",
          status: "open",
        },
        {
          id: 3,
          type: "YanlÄ±ÅŸ PPE",
          description: "Uygun olmayan ayakkabÄ±",
          timestamp: new Date(
            Date.now() - 2 * 24 * 60 * 60 * 1000
          ).toISOString(),
          location: "BakÄ±m AtÃ¶lyesi",
          status: "resolved",
        },
      ],
    },
    {
      id: 4,
      name: "AyÅŸe Ã‡elik",
      workerId: "EMP004",
      email: "ayse.celik@sirket.com",
      phone: "+90 555 456 78 90",
      department: "Depo",
      location: "Hammadde Deposu",
      position: "Depo Sorumlusu",
      startDate: "2023-05-22",
      status: "active",
      managerId: 4,
      complianceRate: 89.7,
      monthlyViolations: 1,
      recentViolations: 1,
      lastSeen: new Date(Date.now() - 4 * 60 * 60 * 1000).toISOString(), // 4 saat Ã¶nce
      safetyScore: 82,
      trainingStatus: "completed",
      completedTrainings: 6,
      notes: "Ä°yi performans, ara sÄ±ra hatÄ±rlatma gerekiyor.",
      photo: null,
      assignedPPE: [
        {
          type: "Baret",
          status: "assigned",
          assignedDate: "2023-05-22",
          lastCheck: "2025-06-01",
          condition: "good",
        },
        {
          type: "Yelek",
          status: "assigned",
          assignedDate: "2023-05-22",
          lastCheck: "2025-06-01",
          condition: "excellent",
        },
        {
          type: "AyakkabÄ±",
          status: "assigned",
          assignedDate: "2023-05-22",
          lastCheck: "2025-06-01",
          condition: "good",
        },
      ],
      recentViolations: [
        {
          id: 4,
          type: "Eksik PPE",
          description: "GÃ¼venlik bareti takÄ±lmamÄ±ÅŸ",
          timestamp: new Date(
            Date.now() - 5 * 24 * 60 * 60 * 1000
          ).toISOString(),
          location: "Hammadde Deposu",
          status: "resolved",
        },
      ],
    },
    {
      id: 5,
      name: "Can Ã–zkan",
      workerId: "EMP005",
      email: "can.ozkan@sirket.com",
      phone: "+90 555 567 89 01",
      department: "Ãœretim",
      location: "Montaj AlanÄ±",
      position: "Montaj OperatÃ¶rÃ¼",
      startDate: "2024-01-08",
      status: "training",
      managerId: 1,
      complianceRate: 65.4,
      monthlyViolations: 8,
      recentViolations: 4,
      lastSeen: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(), // 1 gÃ¼n Ã¶nce
      safetyScore: 45,
      trainingStatus: "in-progress",
      completedTrainings: 2,
      notes: "Yeni Ã§alÄ±ÅŸan, yoÄŸun eÄŸitim programÄ±nda.",
      photo: null,
      assignedPPE: [
        {
          type: "Baret",
          status: "assigned",
          assignedDate: "2024-01-08",
          lastCheck: "2025-06-01",
          condition: "good",
        },
        {
          type: "GÃ¶zlÃ¼k",
          status: "missing",
          assignedDate: "2024-01-08",
          lastCheck: "2025-05-01",
          condition: "poor",
        },
        {
          type: "Eldiven",
          status: "assigned",
          assignedDate: "2024-01-08",
          lastCheck: "2025-06-01",
          condition: "fair",
        },
      ],
      recentViolations: [
        {
          id: 5,
          type: "Eksik PPE",
          description: "GÃ¼venlik gÃ¶zlÃ¼ÄŸÃ¼ takÄ±lmamÄ±ÅŸ",
          timestamp: new Date(
            Date.now() - 1 * 24 * 60 * 60 * 1000
          ).toISOString(),
          location: "Montaj AlanÄ±",
          status: "open",
        },
      ],
    },
  ];

  console.log("âœ… Workers gÃ¶nderiliyor:", mockWorkers.length, "adet");
  res.json(mockWorkers);
});

// 5. YÃ¶neticileri getir (managers iÃ§in)
router.get("/workers", (req, res) => {
  // EÄŸer role=manager query'si varsa sadece yÃ¶neticileri dÃ¶ndÃ¼r
  if (req.query.role === "manager") {
    console.log("ðŸ‘” Managers istendi");

    const mockManagers = [
      {
        id: 1,
        name: "Ali Veli",
        position: "Ãœretim MÃ¼dÃ¼rÃ¼",
        department: "Ãœretim",
      },
      {
        id: 2,
        name: "Zeynep Ak",
        position: "Kalite MÃ¼dÃ¼rÃ¼",
        department: "Kalite Kontrol",
      },
      {
        id: 3,
        name: "Hasan Ã–z",
        position: "BakÄ±m MÃ¼dÃ¼rÃ¼",
        department: "BakÄ±m-OnarÄ±m",
      },
      { id: 4, name: "Elif Kara", position: "Depo MÃ¼dÃ¼rÃ¼", department: "Depo" },
    ];

    console.log("âœ… Managers gÃ¶nderiliyor:", mockManagers.length, "adet");
    return res.json(mockManagers);
  }

  // Normal workers endpoint'i yukarÄ±da zaten var
});

// 6. Tekil Ã§alÄ±ÅŸan getir
router.get("/workers/:id", (req, res) => {
  console.log("ðŸ‘¤ Worker detayÄ± istendi, ID:", req.params.id);

  // Bu normalde veritabanÄ±ndan gelecek
  const worker = {
    id: parseInt(req.params.id),
    name: "Ã–rnek Ã‡alÄ±ÅŸan",
    workerId: "EMP" + req.params.id.padStart(3, "0"),
    // ... diÄŸer detaylar
  };

  console.log("âœ… Worker detayÄ± gÃ¶nderiliyor");
  res.json(worker);
});

// 7. Yeni Ã§alÄ±ÅŸan ekle
router.post("/workers", (req, res) => {
  console.log("âž• Yeni worker ekleniyor:", req.body);

  const newWorker = {
    id: Date.now(), // GeÃ§ici ID
    ...req.body,
    createdAt: new Date().toISOString(),
  };

  console.log("âœ… Worker eklendi:", newWorker.id);
  res.status(201).json(newWorker);
});

// 8. Ã‡alÄ±ÅŸan gÃ¼ncelle
router.put("/workers/:id", (req, res) => {
  console.log("âœï¸ Worker gÃ¼ncelleniyor, ID:", req.params.id, "Data:", req.body);

  const updatedWorker = {
    id: parseInt(req.params.id),
    ...req.body,
    updatedAt: new Date().toISOString(),
  };

  console.log("âœ… Worker gÃ¼ncellendi");
  res.json(updatedWorker);
});

// 9. Ã‡alÄ±ÅŸan pasifleÅŸtir
router.put("/workers/:id/deactivate", (req, res) => {
  console.log("ðŸš« Worker pasifleÅŸtiriliyor, ID:", req.params.id);

  console.log("âœ… Worker pasifleÅŸtirildi");
  res.json({ message: "Ã‡alÄ±ÅŸan pasifleÅŸtirildi", id: req.params.id });
});

// 10. Ã‡alÄ±ÅŸan geÃ§miÅŸi
router.get("/workers/history", (req, res) => {
  console.log("ðŸ“‹ Worker history istendi, params:", req.query);

  const mockHistory = [
    {
      id: 1,
      type: "violation",
      title: "PPE Ä°hlali",
      description: "GÃ¼venlik gÃ¶zlÃ¼ÄŸÃ¼ takÄ±lmamÄ±ÅŸ",
      timestamp: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
      details: { location: "Ana Ãœretim HattÄ±", severity: "Orta" },
    },
    {
      id: 2,
      type: "training",
      title: "GÃ¼venlik EÄŸitimi TamamlandÄ±",
      description: "Temel Ä°ÅŸ GÃ¼venliÄŸi eÄŸitimi baÅŸarÄ±yla tamamlandÄ±",
      timestamp: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
      details: { duration: "4 saat", score: "95" },
    },
    {
      id: 3,
      type: "ppe",
      title: "PPE AtandÄ±",
      description: "Yeni gÃ¼venlik eldiveni atandÄ±",
      timestamp: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString(),
      details: { type: "Eldiven", condition: "Yeni" },
    },
  ];

  console.log("âœ… Worker history gÃ¶nderiliyor:", mockHistory.length, "kayÄ±t");
  res.json(mockHistory);
});

// 11. PPE atama
router.post("/workers/assign-ppe", (req, res) => {
  console.log("ðŸ¦º PPE atanÄ±yor:", req.body);

  const { workerId, ppeTypes, assignmentDate, notes } = req.body;

  console.log("âœ… PPE atandÄ±:", ppeTypes.length, "adet");
  res.json({
    message: "PPE baÅŸarÄ±yla atandÄ±",
    workerId,
    assignedPPE: ppeTypes,
    assignmentDate,
  });
});

// 12. PPE kaldÄ±r
router.delete("/workers/:workerId/ppe/:ppeType", (req, res) => {
  console.log("ðŸ—‘ï¸ PPE kaldÄ±rÄ±lÄ±yor:", req.params);

  console.log("âœ… PPE kaldÄ±rÄ±ldÄ±");
  res.json({
    message: "PPE kaldÄ±rÄ±ldÄ±",
    workerId: req.params.workerId,
    ppeType: req.params.ppeType,
  });
});

// 13. Ã‡alÄ±ÅŸan raporu oluÅŸtur
router.post("/workers/:id/report", (req, res) => {
  console.log("ðŸ“„ Worker raporu oluÅŸturuluyor, ID:", req.params.id);

  // Mock PDF response
  res.setHeader("Content-Type", "application/pdf");
  res.setHeader(
    "Content-Disposition",
    "attachment; filename=worker-report.pdf"
  );

  console.log("âœ… Worker raporu oluÅŸturuldu");
  res.send(Buffer.from("Mock PDF content"));
});

// 14. Ã‡alÄ±ÅŸan dÄ±ÅŸa aktarma
router.post("/workers/export", (req, res) => {
  console.log("ðŸ“Š Workers export istendi, filters:", req.body.filters);

  // Mock Excel response
  res.setHeader(
    "Content-Type",
    "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
  );
  res.setHeader("Content-Disposition", "attachment; filename=workers.xlsx");

  console.log("âœ… Workers export hazÄ±rlandÄ±");
  res.send(Buffer.from("Mock Excel content"));
});

// 15. Ä°Ã§e aktarma ÅŸablonu
router.get("/workers/import/template", (req, res) => {
  console.log("ðŸ“‹ Import template istendi");

  // Mock Excel template
  res.setHeader(
    "Content-Type",
    "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
  );
  res.setHeader(
    "Content-Disposition",
    "attachment; filename=workers-template.xlsx"
  );

  console.log("âœ… Import template hazÄ±rlandÄ±");
  res.send(Buffer.from("Mock Excel template"));
});

// 16. Ä°Ã§e aktarma Ã¶nizleme
router.post("/workers/import/preview", (req, res) => {
  console.log("ðŸ” Import preview istendi");

  // Mock import preview data
  const mockPreviewData = [
    {
      name: "Test Ã‡alÄ±ÅŸan 1",
      workerId: "EMP999",
      department: "Ãœretim",
      position: "OperatÃ¶r",
      errors: [],
    },
    {
      name: "Test Ã‡alÄ±ÅŸan 2",
      workerId: "EMP998",
      department: "Bilinmeyen",
      position: "Teknisyen",
      errors: ["GeÃ§ersiz departman"],
    },
  ];

  console.log("âœ… Import preview hazÄ±rlandÄ±");
  res.json(mockPreviewData);
});

// 17. Ä°Ã§e aktarma
router.post("/workers/import", (req, res) => {
  console.log("ðŸ“¥ Workers import baÅŸlÄ±yor:", req.body.workers?.length, "kayÄ±t");

  console.log("âœ… Workers import tamamlandÄ±");
  res.json({
    message: "Ä°Ã§e aktarma tamamlandÄ±",
    imported: req.body.workers?.length || 0,
    failed: 0,
  });
});


// ================================
// VIOLATIONS ENDPOINTS (Mevcut)
// ================================

// Violations stats (Ã¶nceki koddan)
router.get("/violations", (req, res) => {
  console.log("âš ï¸ Violations listesi istendi");

  const mockViolations = [
    {
      id: 1,
      worker_id: "EMP001",
      worker_name: "Ahmet YÄ±lmaz",
      violation_type: "Eksik PPE",
      description: "GÃ¼venlik gÃ¶zlÃ¼ÄŸÃ¼ takÄ±lmamÄ±ÅŸ",
      location: "Ana Ãœretim HattÄ±",
      timestamp: Math.floor(Date.now() / 1000) - 3600, // 1 saat Ã¶nce
      severity: "medium",
      status: "open",
      image_url: null,
      confidence: 0.92,
    },
    {
      id: 2,
      worker_id: "EMP003",
      worker_name: "Mehmet Kaya",
      violation_type: "YanlÄ±ÅŸ PPE",
      description: "Uygun olmayan eldiven kullanÄ±mÄ±",
      location: "BakÄ±m AtÃ¶lyesi",
      timestamp: Math.floor(Date.now() / 1000) - 7200, // 2 saat Ã¶nce
      severity: "high",
      status: "resolved",
      image_url: null,
      confidence: 0.87,
    },
    {
      id: 3,
      worker_id: "EMP002",
      worker_name: "Fatma Demir",
      violation_type: "Eksik PPE",
      description: "GÃ¼venlik bareti takÄ±lmamÄ±ÅŸ",
      location: "Kalite LaboratuvarÄ±",
      timestamp: Math.floor(Date.now() / 1000) - 10800, // 3 saat Ã¶nce
      severity: "low",
      status: "open",
      image_url: null,
      confidence: 0.78,
    },
    {
      id: 4,
      worker_id: "EMP004",
      worker_name: "AyÅŸe Ã‡elik",
      violation_type: "Eksik PPE",
      description: "GÃ¼venlik yeleÄŸi takÄ±lmamÄ±ÅŸ",
      location: "Hammadde Deposu",
      timestamp: Math.floor(Date.now() / 1000) - 14400, // 4 saat Ã¶nce
      severity: "medium",
      status: "resolved",
      image_url: null,
      confidence: 0.95,
    },
    {
      id: 5,
      worker_id: "EMP005",
      worker_name: "Can Ã–zkan",
      violation_type: "YanlÄ±ÅŸ PPE",
      description: "Uygun olmayan ayakkabÄ±",
      location: "Montaj AlanÄ±",
      timestamp: Math.floor(Date.now() / 1000) - 18000, // 5 saat Ã¶nce
      severity: "high",
      status: "open",
      image_url: null,
      confidence: 0.89,
    },
    {
      id: 6,
      worker_id: "EMP001",
      worker_name: "Ahmet YÄ±lmaz",
      violation_type: "Eksik PPE",
      description: "Ä°ÅŸ eldiveni takÄ±lmamÄ±ÅŸ",
      location: "Ana Ãœretim HattÄ±",
      timestamp: Math.floor(Date.now() / 1000) - 21600, // 6 saat Ã¶nce
      severity: "medium",
      status: "resolved",
      image_url: null,
      confidence: 0.91,
    },
    {
      id: 7,
      worker_id: "EMP003",
      worker_name: "Mehmet Kaya",
      violation_type: "Eksik PPE",
      description: "Solunum maskesi takÄ±lmamÄ±ÅŸ",
      location: "BakÄ±m AtÃ¶lyesi",
      timestamp: Math.floor(Date.now() / 1000) - 25200, // 7 saat Ã¶nce
      severity: "high",
      status: "open",
      image_url: null,
      confidence: 0.86,
    },
    {
      id: 8,
      worker_id: "EMP002",
      worker_name: "Fatma Demir",
      violation_type: "YanlÄ±ÅŸ PPE",
      description: "Eski model gÃ¼venlik gÃ¶zlÃ¼ÄŸÃ¼",
      location: "Kalite LaboratuvarÄ±",
      timestamp: Math.floor(Date.now() / 1000) - 28800, // 8 saat Ã¶nce
      severity: "low",
      status: "resolved",
      image_url: null,
      confidence: 0.73,
    },
    {
      id: 9,
      worker_id: "EMP004",
      worker_name: "AyÅŸe Ã‡elik",
      violation_type: "Eksik PPE",
      description: "GÃ¼venlik kulaklÄ±ÄŸÄ± takÄ±lmamÄ±ÅŸ",
      location: "Hammadde Deposu",
      timestamp: Math.floor(Date.now() / 1000) - 32400, // 9 saat Ã¶nce
      severity: "medium",
      status: "open",
      image_url: null,
      confidence: 0.88,
    },
    {
      id: 10,
      worker_id: "EMP005",
      worker_name: "Can Ã–zkan",
      violation_type: "Eksik PPE",
      description: "GÃ¼venlik gÃ¶zlÃ¼ÄŸÃ¼ takÄ±lmamÄ±ÅŸ",
      location: "Montaj AlanÄ±",
      timestamp: Math.floor(Date.now() / 1000) - 36000, // 10 saat Ã¶nce
      severity: "high",
      status: "resolved",
      image_url: null,
      confidence: 0.94,
    },
    {
      id: 11,
      worker_id: "EMP001",
      worker_name: "Ahmet YÄ±lmaz",
      violation_type: "YanlÄ±ÅŸ PPE",
      description: "HasarlÄ± gÃ¼venlik bareti",
      location: "Ana Ãœretim HattÄ±",
      timestamp: Math.floor(Date.now() / 1000) - 39600, // 11 saat Ã¶nce
      severity: "medium",
      status: "open",
      image_url: null,
      confidence: 0.82,
    },
    {
      id: 12,
      worker_id: "EMP003",
      worker_name: "Mehmet Kaya",
      violation_type: "Eksik PPE",
      description: "GÃ¼venlik ayakkabÄ±sÄ± takÄ±lmamÄ±ÅŸ",
      location: "BakÄ±m AtÃ¶lyesi",
      timestamp: Math.floor(Date.now() / 1000) - 43200, // 12 saat Ã¶nce
      severity: "high",
      status: "resolved",
      image_url: null,
      confidence: 0.9,
    },
    {
      id: 13,
      worker_id: "EMP002",
      worker_name: "Fatma Demir",
      violation_type: "Eksik PPE",
      description: "Ä°ÅŸ eldiveni takÄ±lmamÄ±ÅŸ",
      location: "Kalite LaboratuvarÄ±",
      timestamp: Math.floor(Date.now() / 1000) - 46800, // 13 saat Ã¶nce
      severity: "low",
      status: "open",
      image_url: null,
      confidence: 0.76,
    },
    {
      id: 14,
      worker_id: "EMP004",
      worker_name: "AyÅŸe Ã‡elik",
      violation_type: "YanlÄ±ÅŸ PPE",
      description: "Uygun olmayan iÅŸ eldiveni",
      location: "Hammadde Deposu",
      timestamp: Math.floor(Date.now() / 1000) - 50400, // 14 saat Ã¶nce
      severity: "medium",
      status: "resolved",
      image_url: null,
      confidence: 0.85,
    },
    {
      id: 15,
      worker_id: "EMP005",
      worker_name: "Can Ã–zkan",
      violation_type: "Eksik PPE",
      description: "GÃ¼venlik yeleÄŸi takÄ±lmamÄ±ÅŸ",
      location: "Montaj AlanÄ±",
      timestamp: Math.floor(Date.now() / 1000) - 54000, // 15 saat Ã¶nce
      severity: "high",
      status: "open",
      image_url: null,
      confidence: 0.93,
    },
  ];

  console.log("âœ… Violations gÃ¶nderiliyor:", mockViolations.length, "adet");

  // Ã–NEMLÄ°: Frontend violations array'i bekliyor, obje deÄŸil!
  res.json(mockViolations);
});

// Violations stats - GÃœNCELLENMÄ°Åž
router.get("/violations/stats", (req, res) => {
  console.log("ðŸ“Š Violation stats istendi");

  const now = Math.floor(Date.now() / 1000);
  const today = now - (now % 86400); // BugÃ¼nÃ¼n baÅŸlangÄ±cÄ±

  const mockStats = {
    total: 15,
    today: 3,
    uniqueWorkers: 8,
    complianceRate: 87.5,
    byType: {
      "Eksik PPE": 10,
      "YanlÄ±ÅŸ PPE": 5,
    },
    bySeverity: {
      high: 5,
      medium: 7,
      low: 3,
    },
    byStatus: {
      open: 8,
      resolved: 7,
    },
    byLocation: {
      "Ana Ãœretim HattÄ±": 3,
      "BakÄ±m AtÃ¶lyesi": 3,
      "Kalite LaboratuvarÄ±": 3,
      "Hammadde Deposu": 3,
      "Montaj AlanÄ±": 3,
    },
    trend: {
      thisWeek: 15,
      lastWeek: 18,
      change: -16.7,
    },
  };

  console.log("âœ… Violation stats gÃ¶nderiliyor:", mockStats);
  res.json(mockStats);
});

// Violation gÃ¼ncelle
router.put("/violations/:id", (req, res) => {
  console.log(
    "âœï¸ Violation gÃ¼ncelleniyor, ID:",
    req.params.id,
    "Data:",
    req.body
  );

  const updatedViolation = {
    id: parseInt(req.params.id),
    ...req.body,
    updatedAt: new Date().toISOString(),
  };

  console.log("âœ… Violation gÃ¼ncellendi");
  res.json(updatedViolation);
});

// Violation sil
router.delete("/violations/:id", (req, res) => {
  console.log("ðŸ—‘ï¸ Violation siliniyor, ID:", req.params.id);

  console.log("âœ… Violation silindi");
  res.json({ message: "Violation silindi", id: req.params.id });
});

// Violations export
router.post("/violations/export", (req, res) => {
  console.log("ðŸ“Š Violations export istendi, filters:", req.body);

  // Mock Excel response
  res.setHeader(
    "Content-Type",
    "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
  );
  res.setHeader("Content-Disposition", "attachment; filename=violations.xlsx");

  console.log("âœ… Violations export hazÄ±rlandÄ±");
  res.send(Buffer.from("Mock Excel content"));
});

router.get("/settings", (req, res) => {
  console.log("âš™ï¸ Settings istendi");

  const mockSettings = {
    // Kamera AyarlarÄ±
    camera: {
      url: "rtsp://192.168.1.100:554/stream",
      fpsLimit: 30,
      resolution: "1920x1080",
      enabled: true,
      recordingEnabled: false,
      recordingPath: "/recordings",
      streamQuality: "high",
    },

    // AI Model AyarlarÄ±
    ai: {
      modelPath: "model/best.pt",
      confidenceThreshold: 0.5, // 50%
      nmsThreshold: 0.4, // 40%
      inputSize: 640,
      batchSize: 1,
      deviceType: "cpu", // cpu, gpu, auto
      enableGPU: false,
      maxDetections: 100,
    },

    // Bildirim AyarlarÄ±
    notifications: {
      emailEnabled: true,
      smsEnabled: false,
      pushEnabled: true,
      emailRecipients: ["admin@sirket.com", "guvenlik@sirket.com"],
      smsRecipients: ["+90555123456"],
      violationNotifications: true,
      dailyReports: true,
      weeklyReports: true,
      criticalAlerts: true,
    },

    // Sistem AyarlarÄ±
    system: {
      language: "tr",
      timezone: "Europe/Istanbul",
      dateFormat: "DD/MM/YYYY",
      timeFormat: "24h",
      autoBackup: true,
      backupInterval: "daily",
      backupRetention: 30, // gÃ¼n
      logLevel: "info",
      maxLogSize: 100, // MB
      sessionTimeout: 30, // dakika
    },

    // GÃ¼venlik AyarlarÄ±
    security: {
      passwordPolicy: {
        minLength: 8,
        requireUppercase: true,
        requireLowercase: true,
        requireNumbers: true,
        requireSymbols: false,
        expirationDays: 90,
      },
      twoFactorAuth: false,
      loginAttempts: 5,
      lockoutDuration: 15, // dakika
      sessionSecurity: "medium",
      ipWhitelist: [],
      auditLog: true,
    },

    // Performans AyarlarÄ±
    performance: {
      cacheEnabled: true,
      cacheSize: 256, // MB
      compressionEnabled: true,
      optimizeImages: true,
      lazyLoading: true,
      maxConcurrentStreams: 4,
      processingQueue: 10,
      memoryLimit: 1024, // MB
    },

    // Ä°ntegrasyon AyarlarÄ±
    integrations: {
      database: {
        host: "localhost",
        port: 5432,
        name: "ppe_system",
        ssl: false,
        poolSize: 10,
      },
      api: {
        rateLimit: 1000, // requests/hour
        timeout: 30, // seconds
        retryAttempts: 3,
        enableCors: true,
      },
      webhook: {
        enabled: false,
        url: "",
        secret: "",
        events: ["violation", "alert"],
      },
    },
  };

  console.log("âœ… Settings gÃ¶nderiliyor");
  res.json(mockSettings);
});

// Sistem ayarlarÄ±nÄ± gÃ¼ncelle
router.put("/settings", (req, res) => {
  console.log("ðŸ’¾ Settings gÃ¼ncelleniyor:", req.body);

  const updatedSettings = {
    ...req.body,
    updatedAt: new Date().toISOString(),
    updatedBy: "admin", // Normalde JWT'den gelecek
  };

  console.log("âœ… Settings gÃ¼ncellendi");
  res.json({
    message: "Ayarlar baÅŸarÄ±yla gÃ¼ncellendi",
    settings: updatedSettings,
  });
});

// Belirli kategori ayarlarÄ±nÄ± getir
router.get("/settings/:category", (req, res) => {
  console.log("âš™ï¸ Settings kategorisi istendi:", req.params.category);

  const category = req.params.category;
  const allSettings = {
    camera: {
      url: "rtsp://192.168.1.100:554/stream",
      fpsLimit: 30,
      resolution: "1920x1080",
      enabled: true,
    },
    ai: {
      modelPath: "model/best.pt",
      confidenceThreshold: 0.5,
      nmsThreshold: 0.4,
      inputSize: 640,
    },
    notifications: {
      emailEnabled: true,
      smsEnabled: false,
      pushEnabled: true,
    },
    system: {
      language: "tr",
      timezone: "Europe/Istanbul",
      dateFormat: "DD/MM/YYYY",
    },
  };

  if (allSettings[category]) {
    console.log("âœ… Settings kategorisi gÃ¶nderiliyor:", category);
    res.json(allSettings[category]);
  } else {
    console.log("âŒ Bilinmeyen settings kategorisi:", category);
    res.status(404).json({ error: "Kategori bulunamadÄ±" });
  }
});

// Belirli kategori ayarlarÄ±nÄ± gÃ¼ncelle
router.put("/settings/:category", (req, res) => {
  console.log(
    "ðŸ’¾ Settings kategorisi gÃ¼ncelleniyor:",
    req.params.category,
    req.body
  );

  const updatedCategorySettings = {
    category: req.params.category,
    ...req.body,
    updatedAt: new Date().toISOString(),
  };

  console.log("âœ… Settings kategorisi gÃ¼ncellendi");
  res.json({
    message: `${req.params.category} ayarlarÄ± gÃ¼ncellendi`,
    settings: updatedCategorySettings,
  });
});

// AyarlarÄ± varsayÄ±lana sÄ±fÄ±rla
router.post("/settings/reset", (req, res) => {
  console.log("ðŸ”„ Settings sÄ±fÄ±rlanÄ±yor, kategori:", req.body.category);

  const { category } = req.body;

  if (category) {
    console.log("âœ… Settings kategorisi sÄ±fÄ±rlandÄ±:", category);
    res.json({ message: `${category} ayarlarÄ± sÄ±fÄ±rlandÄ±` });
  } else {
    console.log("âœ… TÃ¼m settings sÄ±fÄ±rlandÄ±");
    res.json({ message: "TÃ¼m ayarlar sÄ±fÄ±rlandÄ±" });
  }
});

// AyarlarÄ± dÄ±ÅŸa aktar
router.get("/settings/export", (req, res) => {
  console.log("ðŸ“¤ Settings export istendi");

  // Mock JSON export
  res.setHeader("Content-Type", "application/json");
  res.setHeader("Content-Disposition", "attachment; filename=settings.json");

  const exportData = {
    exportedAt: new Date().toISOString(),
    version: "1.0.0",
    settings: {
      camera: { url: "rtsp://192.168.1.100:554/stream", fpsLimit: 30 },
      ai: { modelPath: "model/best.pt", confidenceThreshold: 0.5 },
    },
  };

  console.log("âœ… Settings export hazÄ±rlandÄ±");
  res.json(exportData);
});

// AyarlarÄ± iÃ§e aktar
router.post("/settings/import", (req, res) => {
  console.log("ðŸ“¥ Settings import baÅŸlÄ±yor:", req.body);

  const { settings, overwrite = false } = req.body;

  console.log("âœ… Settings import tamamlandÄ±");
  res.json({
    message: "Ayarlar baÅŸarÄ±yla iÃ§e aktarÄ±ldÄ±",
    imported: Object.keys(settings || {}).length,
    overwrite,
  });
});

// Sistem durumu kontrolÃ¼
router.get("/settings/health", (req, res) => {
  console.log("ðŸ¥ System health check istendi");

  const healthStatus = {
    status: "healthy",
    timestamp: new Date().toISOString(),
    services: {
      database: { status: "up", responseTime: 45 },
      camera: { status: "up", responseTime: 120 },
      ai: { status: "up", responseTime: 230 },
      storage: { status: "up", usage: "45%" },
    },
    system: {
      uptime: "2d 14h 32m",
      memory: { used: "512MB", total: "2GB", percentage: 25 },
      cpu: { usage: "15%", temperature: "45Â°C" },
      disk: { used: "45GB", total: "100GB", percentage: 45 },
    },
    version: "1.0.0",
    environment: "production",
  };

  console.log("âœ… System health gÃ¶nderiliyor");
  res.json(healthStatus);
});

// Ayar validasyonu
router.post("/settings/validate", (req, res) => {
  console.log("âœ… Settings validation istendi:", req.body);

  const { category, settings } = req.body;
  const validationResults = {
    valid: true,
    errors: [],
    warnings: [],
  };

  // Mock validation
  if (category === "camera" && settings.fpsLimit > 60) {
    validationResults.warnings.push(
      "YÃ¼ksek FPS deÄŸeri performansÄ± etkileyebilir"
    );
  }

  if (category === "ai" && settings.confidenceThreshold < 0.3) {
    validationResults.warnings.push(
      "DÃ¼ÅŸÃ¼k gÃ¼ven eÅŸiÄŸi yanlÄ±ÅŸ pozitif sonuÃ§lar verebilir"
    );
  }

  console.log("âœ… Settings validation tamamlandÄ±");
  res.json(validationResults);
});

// Ayar geÃ§miÅŸi
router.get("/settings/history", (req, res) => {
  console.log("ðŸ“‹ Settings history istendi");

  const mockHistory = [
    {
      id: 1,
      category: "camera",
      action: "update",
      field: "fpsLimit",
      oldValue: 25,
      newValue: 30,
      changedBy: "admin",
      timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(),
      reason: "Performans iyileÅŸtirmesi",
    },
    {
      id: 2,
      category: "ai",
      action: "update",
      field: "confidenceThreshold",
      oldValue: 0.6,
      newValue: 0.5,
      changedBy: "admin",
      timestamp: new Date(Date.now() - 5 * 60 * 60 * 1000).toISOString(),
      reason: "Daha hassas tespit iÃ§in",
    },
    {
      id: 3,
      category: "notifications",
      action: "update",
      field: "emailEnabled",
      oldValue: false,
      newValue: true,
      changedBy: "admin",
      timestamp: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString(),
      reason: "E-posta bildirimlerini etkinleÅŸtir",
    },
  ];

  console.log("âœ… Settings history gÃ¶nderiliyor:", mockHistory.length, "kayÄ±t");
  res.json(mockHistory);
});


module.exports = router;
